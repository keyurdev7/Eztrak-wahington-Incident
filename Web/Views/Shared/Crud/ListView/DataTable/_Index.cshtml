@using System.Web
@using ViewModels
@model ViewModels.CRUD.CrudListViewModel
@{
    ViewBag.Title = Model.Title;
    if (Model.IsLayoutNull)
    {
        Layout = null;
    }
    else
    {
        Layout = "~/Views/Shared/_Layout.cshtml";
    }
    var createUrl = HttpUtility.UrlDecode(Url.Action(Model.CreateButtonAction ?? "Create", Model.ControllerName));
    var controllerName = Model.ControllerName;
    var makeColumnsClickable = Model.MakeColumnsClickable;
}

<link href="~/css/bundles/datatable-buttons.css" rel="stylesheet" />
<link href="~/css/bundles/datatable.css" rel="stylesheet" />
<script src="~/js/custom/loader/loader.js"></script>
@if (Model.LoadDatatableScript)
{
    @* <script src="~/js/bundles/custom-datatable.js"></script> *@
    <script src="~/js/custom/datatable/auto-datatable.js" asp-append-version="true"></script>

    <!--Placed here because Assets Screen have to Extend Datatable Manager-->
}
<div class="container-fluid">
<div class="page-top d-lg-flex justify-content-between align-items-center mb-3 p-title">
    @if (Model.HideTitle == false)
    {
        if (!string.IsNullOrEmpty(Model.TitleHtml))
        {
            @Html.Raw(Model.TitleHtml)
        }
        else
        {
            <h3 class="page-title text-site-primary m-md-0">@Model.Title</h3>
        }
    }
    @if (Model.HideTopSearchBar == false)
    {
        @await Html.PartialAsync("~/Views/Shared/Crud/ListView/Common/_TopSearchBar.cshtml")
    }
    @if (Model.HideCreateButton == false)
    {
        <div class="ms-auto">
            <button type="button" class="btn orange" onclick="loadCreateModalPanel('@createUrl')"
                    data-bs-target="#newSupModal">
                <i class="fa-regular fa-square-plus"></i>
                Add New
            </button>
        </div>

    }
</div>
</div>
@if (string.IsNullOrEmpty(Model.TableViewPath))
{
    @await Html.PartialAsync("~/Views/Shared/Crud/ListView/DataTable/_Table.cshtml", Model)
}
else
{
    @await Html.PartialAsync(Model.TableViewPath, Model)
}

<div class="modal fade" id="crudDeleteModal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Enter your password:</h4>
                <button type="button" class="close" data-bs-dismiss="modal">&times;</button>
            </div>
            <div id="crudDeleteModalPanelBody" class="modal-body">
                <div id="crudDeleteModalError">
                </div>
                <input name="Password" type="password" id="user-password" class="form-control" placeholder="Password"
                       autocomplete="new-password" />
                <br />
                <div class="text-center">
                    <button type="button" class="btn btn-dark" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn blue-btn" id="validate-password">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>




<div id="data-cell-edit-form-div">
    <form id="data-cell-edit-form">
    </form>
</div>

@if (Model.LoadDatatableScript)
{
    <script src="~/js/bundles/datatable.js"></script>
    <script src="~/js/bundles/datatable-buttons.js"></script>
}
<script src="~/js/custom/crud/ajaxCrud.js"></script>
<partial name="_ValidationScriptsPartial" />

<script>

    var clickTimer;
    var delay = 250;

    $(function () {
    @if (Model.LoadDefaultDatatableScript)
    {
        @:ReInitializeDataTables();
    }
                        var timeoutId; // Variable to store the timer ID
        $("body").off("click", ".crud-list-table > tbody > tr > td:not(.action)");
        $("body").on("click", ".crud-list-table > tbody > tr > td:not(.action)", function () {
            if ($(this).find(".processing").length > 0) {
                return;
            }
            clearTimeout(timeoutId); // Clear any previous timer
            timeoutId = setTimeout(() => {
                // Single click handler
                var flag = '@makeColumnsClickable';
                if (flag === 'True') {
                    var id = $(this).parent().attr("id");
                    var controllerName = "@controllerName";
                    var actionname = "@Model.RowClickDefaultAction";
                    var url = '/' + controllerName + '/' + actionname + '/' + id;
                    loadUpdateAndDetailModalPanel(url);
                }

            }, 350); // Set a timer for 250 milliseconds

        });
        $("body").off("dblclick", ".crud-list-table > tbody > tr > td:not(.action)");
        $("body").on("dblclick", ".crud-list-table > tbody > tr > td:not(.action)", function () {
            clearTimeout(timeoutId); // Clear the timer if a double click occurs
        });


    });

    @if (Model.LoadDefaultDatatableScript)
    {
        <text>
                                var dataTableManager = new DataTableManager();
        function ReInitializeDataTables() {
            let formId = $(".search-form").attr('id');
            if ($("#crud-list-table").length > 0) {
                let dataTableId = $("#crud-list-table").attr('id');
                if ($.fn.DataTable.fnIsDataTable($("#" + dataTableId))) {
                    $("#" + dataTableId).dataTable().fnDestroy();
                    $("#crud-list-table").addClass("dataTable");
                }
                dataTableManager.initialize("crud-list-table", formId, @Html.Raw(Model.DatatableColumnsJson), '@Model.ShowDatatableButtons', '@Model.DataUrl', '@Model.IsPasscodeRequiredForDelete');
                // InitializeDataTables();
            }
        }
        </text>
    }
</script>
